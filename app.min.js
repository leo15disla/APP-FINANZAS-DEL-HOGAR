document.addEventListener('DOMContentLoaded', () => { const navItems = document.querySelectorAll('.nav-item'); const views = document.querySelectorAll('.view'); const LOCAL_KEY = 'movimientos'; let movimientos = JSON.parse(localStorage.getItem(LOCAL_KEY)) || JSON.parse(localStorage.getItem('transactions')) || []; let cuentas = JSON.parse(localStorage.getItem('cuentas')) || []; let prestamos = JSON.parse(localStorage.getItem('prestamos')) || []; let presupuestos = JSON.parse(localStorage.getItem('presupuestos')) || []; let ajustes = JSON.parse(localStorage.getItem('ajustes')) || { userName: '', currency: 'USD', darkMode: false, animations: true, fontSize: 'med', contrast: false }; function showView(viewId) { views.forEach((view) => { if (view.id === viewId) { view.classList.add('active'); } else { view.classList.remove('active'); } }); navItems.forEach((item) => { if (item.getAttribute('data-view') === viewId) { item.classList.add('active'); } else { item.classList.remove('active'); } }); switch (viewId) { case 'movimientos': actualizarVistaMovimientos(); break; case 'cuentas': actualizarVistaCuentas(); break; case 'prestamos': actualizarVistaPrestamos(); break; case 'calendario': actualizarVistaCalendario(); break; case 'presupuesto': actualizarVistaPresupuesto(); break; case 'exportar': break; case 'ajustes': cargarAjustes(); break; } } navItems.forEach((item) => { item.addEventListener('click', (e) => { e.preventDefault(); const targetView = item.getAttribute('data-view'); showView(targetView); if (targetView === 'movimientos') { actualizarVistaMovimientos(); } if (targetView === 'cuentas') { actualizarVistaCuentas(); } }); }); function getMonthName(monthIndex) { const months = [ 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre' ]; return months[monthIndex]; } function saveMovimientos() { localStorage.setItem(LOCAL_KEY, JSON.stringify(movimientos)); } function updateDashboard() { const incomeEl = document.getElementById('income-summary-value'); const expenseEl = document.getElementById('expense-summary-value'); const balanceEl = document.getElementById('balance-summary-value'); const differenceEl = document.getElementById('difference-summary-value'); const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); let incomeTotal = 0; let expenseTotal = 0; movimientos.forEach((mov) => { const txDate = new Date(mov.fecha); if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) { if (mov.tipo === 'ingreso') { incomeTotal += parseFloat(mov.monto); } else { expenseTotal += parseFloat(mov.monto); } } }); const balance = incomeTotal - expenseTotal; let prevIncome = 0; let prevExpense = 0; const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1; const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear; movimientos.forEach((mov) => { const txDate = new Date(mov.fecha); if (txDate.getMonth() === prevMonth && txDate.getFullYear() === prevYear) { if (mov.tipo === 'ingreso') prevIncome += parseFloat(mov.monto); else prevExpense += parseFloat(mov.monto); } }); const prevBalance = prevIncome - prevExpense; const diff = balance - prevBalance; incomeEl.textContent = formatCurrency(incomeTotal); expenseEl.textContent = formatCurrency(expenseTotal); balanceEl.textContent = formatCurrency(balance); if (prevIncome === 0 && prevExpense === 0) { differenceEl.textContent = '–'; } else { const sign = diff > 0 ? '+' : ''; differenceEl.textContent = `${sign}${formatCurrency(diff)}`; } const accountsTotalEl = document.getElementById('accounts-total'); const accountsLiquidEl = document.getElementById('accounts-liquid'); const accountsDebtEl = document.getElementById('accounts-debt'); if (accountsTotalEl && accountsLiquidEl && accountsDebtEl) { const totalCuentas = cuentas.reduce((sum, c) => sum + parseFloat(c.saldo || 0), 0); accountsTotalEl.textContent = formatCurrency(totalCuentas); accountsLiquidEl.textContent = formatCurrency(totalCuentas); accountsDebtEl.textContent = formatCurrency(0); } updateBarChart(incomeTotal, expenseTotal); } function formatCurrency(value) { return new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'USD' }).format(value); } function updateBarChart(incomeTotal, expenseTotal) { const chart = document.getElementById('bar-chart'); chart.innerHTML = ''; const maxVal = Math.max(incomeTotal, expenseTotal, 1); const incomeBar = document.createElement('div'); incomeBar.classList.add('bar', 'income'); incomeBar.style.height = `${(incomeTotal / maxVal) * 100}%`; const incomeLabel = document.createElement('span'); incomeLabel.classList.add('bar-label'); incomeLabel.textContent = 'Ingresos'; incomeBar.appendChild(incomeLabel); const expenseBar = document.createElement('div'); expenseBar.classList.add('bar', 'expense'); expenseBar.style.height = `${(expenseTotal / maxVal) * 100}%`; const expenseLabel = document.createElement('span'); expenseLabel.classList.add('bar-label'); expenseLabel.textContent = 'Gastos'; expenseBar.appendChild(expenseLabel); chart.appendChild(incomeBar); chart.appendChild(expenseBar); } function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; document.body.appendChild(toast); requestAnimationFrame(() => { toast.classList.add('show'); }); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { document.body.removeChild(toast); }, 300); }, 3000); } function cargarMovimientos() { movimientos = JSON.parse(localStorage.getItem(LOCAL_KEY)) || []; } function filtrarMovimientos() { const typeSelect = document.getElementById('mov-filter-type'); const rangeSelect = document.getElementById('mov-filter-range'); const categorySelect = document.getElementById('mov-filter-category'); const searchInput = document.getElementById('mov-search'); const typeFilter = typeSelect ? typeSelect.value : 'todos'; const rangeFilter = rangeSelect ? rangeSelect.value : 'todos'; const categoryFilter = categorySelect ? categorySelect.value : 'todas'; const searchText = searchInput ? searchInput.value.trim().toLowerCase() : ''; const now = new Date(); let startDate = null; let endDate = null; if (rangeFilter === 'hoy') { startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1); } else if (rangeFilter === 'semana') { startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6); endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1); } else if (rangeFilter === 'mes') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1); } return movimientos.filter((mov) => { if (typeFilter !== 'todos' && mov.tipo !== typeFilter) { return false; } if (categoryFilter !== 'todas' && mov.categoria !== categoryFilter) { return false; } if (startDate && endDate) { const movDate = new Date(mov.fecha); if (!(movDate >= startDate && movDate < endDate)) { return false; } } if (searchText) { const amountString = parseFloat(mov.monto).toFixed(2); const composite = `${mov.categoria} ${mov.nota} ${amountString}`.toLowerCase(); if (!composite.includes(searchText)) { return false; } } return true; }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); } function actualizarVistaMovimientos() { cargarMovimientos(); const categorySelect = document.getElementById('mov-filter-category'); if (categorySelect) { const currentValue = categorySelect.value || 'todas'; const categories = Array.from(new Set(movimientos.map((m) => m.categoria))).filter(Boolean); categorySelect.innerHTML = ''; const optTodas = document.createElement('option'); optTodas.value = 'todas'; optTodas.textContent = 'Todas'; categorySelect.appendChild(optTodas); categories.forEach((cat) => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; categorySelect.appendChild(opt); }); if (Array.from(categorySelect.options).some((o) => o.value === currentValue)) { categorySelect.value = currentValue; } } const filtered = filtrarMovimientos(); let totalIngreso = 0; let totalGasto = 0; filtered.forEach((m) => { if (m.tipo === 'ingreso') totalIngreso += parseFloat(m.monto); else totalGasto += parseFloat(m.monto); }); const movIngresosTotalEl = document.getElementById('mov-ingresos-total'); const movGastosTotalEl = document.getElementById('mov-gastos-total'); const movBalanceTotalEl = document.getElementById('mov-balance-total'); if (movIngresosTotalEl) movIngresosTotalEl.textContent = formatCurrency(totalIngreso); if (movGastosTotalEl) movGastosTotalEl.textContent = formatCurrency(totalGasto); if (movBalanceTotalEl) movBalanceTotalEl.textContent = formatCurrency(totalIngreso - totalGasto); const listEl = document.getElementById('movimientos-list'); if (!listEl) return; listEl.innerHTML = ''; if (filtered.length === 0) { const empty = document.createElement('p'); empty.textContent = 'No hay movimientos para mostrar.'; empty.style.textAlign = 'center'; listEl.appendChild(empty); return; } filtered.forEach((mov) => { const card = document.createElement('div'); card.classList.add('mov-card'); card.classList.add(mov.tipo); const header = document.createElement('div'); header.classList.add('mov-card-header'); const typeSpan = document.createElement('span'); typeSpan.classList.add('mov-card-type'); typeSpan.textContent = mov.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'; const amountSpan = document.createElement('span'); amountSpan.classList.add('mov-card-amount'); const sign = mov.tipo === 'ingreso' ? '+' : '-'; amountSpan.textContent = `${sign}${formatCurrency(parseFloat(mov.monto))}`; header.appendChild(typeSpan); header.appendChild(amountSpan); const body = document.createElement('div'); body.classList.add('mov-card-body'); const catP = document.createElement('p'); catP.classList.add('mov-category'); catP.textContent = mov.categoria || '-'; const noteP = document.createElement('p'); noteP.classList.add('mov-note'); noteP.textContent = mov.nota || ''; body.appendChild(catP); body.appendChild(noteP); const footer = document.createElement('div'); footer.classList.add('mov-card-footer'); const dateSpan = document.createElement('span'); dateSpan.classList.add('mov-date'); dateSpan.textContent = new Date(mov.fecha).toLocaleDateString('es-DO'); footer.appendChild(dateSpan); card.appendChild(header); card.appendChild(body); card.appendChild(footer); listEl.appendChild(card); }); } function cargarCuentas() { cuentas = JSON.parse(localStorage.getItem('cuentas')) || []; } function guardarCuentas() { localStorage.setItem('cuentas', JSON.stringify(cuentas)); } function actualizarVistaCuentas() { cargarCuentas(); const totalSaldo = cuentas.reduce((sum, c) => sum + parseFloat(c.saldo || 0), 0); const liquidez = totalSaldo; const deuda = 0; const totalEl = document.getElementById('cuentas-total-saldo'); const liquidezEl = document.getElementById('cuentas-liquidez'); const deudaEl = document.getElementById('cuentas-deuda'); if (totalEl) totalEl.textContent = formatCurrency(totalSaldo); if (liquidezEl) liquidezEl.textContent = formatCurrency(liquidez); if (deudaEl) deudaEl.textContent = formatCurrency(deuda); const listEl = document.getElementById('cuentas-list'); if (!listEl) return; listEl.innerHTML = ''; cuentas.slice().reverse().forEach((cuenta) => { const card = document.createElement('div'); card.classList.add('account-card'); card.setAttribute('data-id', cuenta.id); const nameEl = document.createElement('div'); nameEl.classList.add('account-name'); nameEl.textContent = cuenta.nombre; const typeEl = document.createElement('div'); typeEl.classList.add('account-type'); typeEl.textContent = cuenta.tipo.charAt(0).toUpperCase() + cuenta.tipo.slice(1); const balanceEl = document.createElement('div'); balanceEl.classList.add('account-balance'); balanceEl.textContent = formatCurrency(parseFloat(cuenta.saldo)); const updatedEl = document.createElement('div'); updatedEl.classList.add('account-updated'); updatedEl.textContent = cuenta.actualizacion ? new Date(cuenta.actualizacion).toLocaleDateString('es-DO') : ''; card.appendChild(nameEl); card.appendChild(typeEl); card.appendChild(balanceEl); card.appendChild(updatedEl); card.addEventListener('click', () => { const cuentaId = cuenta.id; editarCuenta(cuentaId); }); listEl.appendChild(card); }); } let cuentaEditId = null; function editarCuenta(id) { cargarCuentas(); const cuenta = cuentas.find((c) => c.id === id); if (!cuenta) return; cuentaEditId = id; const nombreEl = document.getElementById('cuenta-nombre'); const tipoEl = document.getElementById('cuenta-tipo'); const saldoEl = document.getElementById('cuenta-saldo'); const notaEl = document.getElementById('cuenta-nota'); if (nombreEl) nombreEl.value = cuenta.nombre; if (tipoEl) tipoEl.value = cuenta.tipo; if (saldoEl) saldoEl.value = parseFloat(cuenta.saldo); if (notaEl) notaEl.value = cuenta.nota || ''; const titleEl = document.getElementById('cuenta-form-title'); if (titleEl) titleEl.textContent = 'Editar cuenta'; } const cuentaForm = document.getElementById('cuenta-form'); if (cuentaForm) { cuentaForm.addEventListener('submit', (e) => { e.preventDefault(); const nombre = document.getElementById('cuenta-nombre').value.trim(); const tipo = document.getElementById('cuenta-tipo').value; const saldoVal = document.getElementById('cuenta-saldo').value; const nota = document.getElementById('cuenta-nota').value.trim(); if (!nombre) { showToast('Introduce un nombre para la cuenta'); return; } if (!tipo) { showToast('Selecciona un tipo de cuenta'); return; } if (!saldoVal || isNaN(saldoVal)) { showToast('Introduce un saldo válido'); return; } const saldo = parseFloat(saldoVal).toFixed(2); cargarCuentas(); if (cuentaEditId) { const idx = cuentas.findIndex((c) => c.id === cuentaEditId); if (idx !== -1) { cuentas[idx] = { ...cuentas[idx], nombre, tipo, saldo, nota, actualizacion: new Date().toISOString() }; } } else { const nuevaCuenta = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), nombre, tipo, saldo, nota, actualizacion: new Date().toISOString() }; cuentas.push(nuevaCuenta); } guardarCuentas(); cuentaForm.reset(); cuentaEditId = null; const titleEl = document.getElementById('cuenta-form-title'); if (titleEl) titleEl.textContent = 'Agregar cuenta'; actualizarVistaCuentas(); updateDashboard(); showToast('Cuenta guardada'); }); } const filterTypeSelect = document.getElementById('mov-filter-type'); const filterRangeSelect = document.getElementById('mov-filter-range'); const filterCategorySelect = document.getElementById('mov-filter-category'); const searchInput = document.getElementById('mov-search'); if (filterTypeSelect) { filterTypeSelect.addEventListener('change', actualizarVistaMovimientos); } if (filterRangeSelect) { filterRangeSelect.addEventListener('change', actualizarVistaMovimientos); } if (filterCategorySelect) { filterCategorySelect.addEventListener('change', actualizarVistaMovimientos); } if (searchInput) { searchInput.addEventListener('input', actualizarVistaMovimientos); } const btnMesActual = document.getElementById('btn-mes-actual'); const btnHistorial = document.getElementById('btn-historial'); if (btnMesActual) { btnMesActual.addEventListener('click', () => { const rangeSelect = document.getElementById('mov-filter-range'); if (rangeSelect) { rangeSelect.value = 'mes'; actualizarVistaMovimientos(); } }); } if (btnHistorial) { btnHistorial.addEventListener('click', () => { const rangeSelect = document.getElementById('mov-filter-range'); if (rangeSelect) { rangeSelect.value = 'todos'; actualizarVistaMovimientos(); } }); } function guardarPrestamos() { localStorage.setItem('prestamos', JSON.stringify(prestamos)); } function calcularFrancesa(principal, annualRate, months, startDate) { const schedule = []; const r = (annualRate / 100) / 12; const cuota = principal * r / (1 - Math.pow(1 + r, -months)); let saldo = principal; let fecha = new Date(startDate); for (let i = 1; i <= months; i++) { const interes = saldo * r; const capital = cuota - interes; saldo = saldo - capital; schedule.push({ cuota: i, fecha: fecha.toISOString().split('T')[0], interes: parseFloat(interes.toFixed(2)), capital: parseFloat(capital.toFixed(2)), cuota_total: parseFloat(cuota.toFixed(2)), saldo_restante: parseFloat(saldo.toFixed(2)) }); fecha.setMonth(fecha.getMonth() + 1); } return schedule; } function calcularAmericana(principal, annualRate, months, startDate) { const schedule = []; const r = (annualRate / 100) / 12; let saldo = principal; let fecha = new Date(startDate); for (let i = 1; i <= months; i++) { const interes = saldo * r; let capital = 0; let cuotaTotal = interes; if (i === months) { capital = principal; cuotaTotal = interes + principal; saldo = 0; } schedule.push({ cuota: i, fecha: fecha.toISOString().split('T')[0], interes: parseFloat(interes.toFixed(2)), capital: parseFloat(capital.toFixed(2)), cuota_total: parseFloat(cuotaTotal.toFixed(2)), saldo_restante: parseFloat(saldo.toFixed(2)) }); fecha.setMonth(fecha.getMonth() + 1); } return schedule; } function calcularInteresCompuestoDiario(principal, annualRate, months, startDate) { const schedule = []; const dailyRate = (annualRate / 100) / 365; const effectiveMonthlyRate = Math.pow(1 + dailyRate, 30) - 1; const cuota = principal * effectiveMonthlyRate / (1 - Math.pow(1 + effectiveMonthlyRate, -months)); let saldo = principal; let fecha = new Date(startDate); for (let i = 1; i <= months; i++) { const interes = saldo * effectiveMonthlyRate; const capital = cuota - interes; saldo = saldo - capital; schedule.push({ cuota: i, fecha: fecha.toISOString().split('T')[0], interes: parseFloat(interes.toFixed(2)), capital: parseFloat(capital.toFixed(2)), cuota_total: parseFloat(cuota.toFixed(2)), saldo_restante: parseFloat(saldo.toFixed(2)) }); fecha.setMonth(fecha.getMonth() + 1); } return schedule; } function actualizarVistaPrestamos() { const listEl = document.getElementById('prestamos-list'); const formContainer = document.getElementById('prestamo-form-container'); if (!listEl) return; listEl.innerHTML = ''; const detalleContainer = document.getElementById('prestamo-detalle-container'); if (detalleContainer) { detalleContainer.classList.add('hidden'); detalleContainer.innerHTML = ''; } if (prestamos.length === 0) { const empty = document.createElement('p'); empty.textContent = 'No hay préstamos registrados.'; empty.style.textAlign = 'center'; listEl.appendChild(empty); return; } prestamos.slice().reverse().forEach((p) => { const card = document.createElement('div'); card.classList.add('loan-card'); card.setAttribute('data-id', p.id); const nameEl = document.createElement('div'); nameEl.classList.add('loan-name'); nameEl.textContent = p.nombre; const infoEl = document.createElement('div'); infoEl.classList.add('loan-info'); infoEl.textContent = `${p.tipo.charAt(0).toUpperCase() + p.tipo.slice(1)} • Monto: ${formatCurrency(parseFloat(p.monto))}`; const progressEl = document.createElement('div'); progressEl.classList.add('loan-progress'); const progressBar = document.createElement('span'); const totalCuotas = p.cronograma.length; const pagadas = p.pagadas ? p.pagadas.length : 0; const porcentaje = totalCuotas ? Math.min(100, (pagadas / totalCuotas) * 100) : 0; progressBar.style.width = `${porcentaje}%`; progressEl.appendChild(progressBar); const metricsEl = document.createElement('div'); metricsEl.classList.add('loan-metrics'); let proxima = p.cronograma.find((c, idx) => !(p.pagadas || []).includes(idx + 1)); const proximaFecha = proxima ? new Date(proxima.fecha).toLocaleDateString('es-DO') : '-'; const saldoPend = proxima ? proxima.saldo_restante + proxima.capital : 0; const nextEl = document.createElement('span'); nextEl.textContent = `Próximo: ${proximaFecha}`; const saldoEl = document.createElement('span'); saldoEl.textContent = `Pendiente: ${formatCurrency(parseFloat(saldoPend || p.monto))}`; metricsEl.appendChild(nextEl); metricsEl.appendChild(saldoEl); card.appendChild(nameEl); card.appendChild(infoEl); card.appendChild(progressEl); card.appendChild(metricsEl); card.addEventListener('click', () => { mostrarDetallePrestamo(p.id); }); listEl.appendChild(card); }); } function mostrarDetallePrestamo(id) { const detalleContainer = document.getElementById('prestamo-detalle-container'); if (!detalleContainer) return; const p = prestamos.find((pl) => pl.id === id); if (!p) return; detalleContainer.classList.remove('hidden'); detalleContainer.innerHTML = ''; const title = document.createElement('h3'); title.textContent = `Detalle de ${p.nombre}`; detalleContainer.appendChild(title); const resumen = document.createElement('p'); resumen.textContent = `Monto: ${formatCurrency(parseFloat(p.monto))} • Tasa anual: ${p.tasa}% • Plazo: ${p.plazo} meses`; detalleContainer.appendChild(resumen); const table = document.createElement('table'); const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>#</th><th>Fecha</th><th>Interés</th><th>Capital</th><th>Cuota</th><th>Saldo</th></tr>'; table.appendChild(thead); const tbody = document.createElement('tbody'); p.cronograma.forEach((c) => { const row = document.createElement('tr'); row.innerHTML = `<td>${c.cuota}</td><td>${new Date(c.fecha).toLocaleDateString('es-DO')}</td><td>${formatCurrency(c.interes)}</td><td>${formatCurrency(c.capital)}</td><td>${formatCurrency(c.cuota_total)}</td><td>${formatCurrency(c.saldo_restante)}</td>`; tbody.appendChild(row); }); table.appendChild(tbody); detalleContainer.appendChild(table); } const btnNuevoPrestamo = document.getElementById('btn-nuevo-prestamo'); const prestamoFormContainer = document.getElementById('prestamo-form-container'); const prestamoForm = document.getElementById('prestamo-form'); if (btnNuevoPrestamo) { btnNuevoPrestamo.addEventListener('click', () => { if (prestamoFormContainer) { prestamoFormContainer.classList.toggle('hidden'); if (!prestamoFormContainer.classList.contains('hidden') && prestamoForm) { prestamoForm.reset(); const title = document.getElementById('prestamo-form-title'); if (title) title.textContent = 'Registrar préstamo'; currentPrestamoEditId = null; } } }); } let currentPrestamoEditId = null; if (prestamoForm) { prestamoForm.addEventListener('submit', (e) => { e.preventDefault(); const nombre = document.getElementById('prestamo-nombre').value.trim(); const tipo = document.getElementById('prestamo-tipo').value; const montoVal = document.getElementById('prestamo-monto').value; const tasaVal = document.getElementById('prestamo-tasa').value; const plazoVal = document.getElementById('prestamo-plazo').value; const fechaInicio = document.getElementById('prestamo-fecha-inicio').value; const fechaPrimer = document.getElementById('prestamo-fecha-primer-pago').value; if (!nombre || !montoVal || !tasaVal || !plazoVal || !fechaInicio || !fechaPrimer) { showToast('Completa todos los campos'); return; } const monto = parseFloat(montoVal); const tasa = parseFloat(tasaVal); const plazo = parseInt(plazoVal); let cronograma = []; if (tipo === 'francesa') { cronograma = calcularFrancesa(monto, tasa, plazo, fechaPrimer); } else if (tipo === 'americana') { cronograma = calcularAmericana(monto, tasa, plazo, fechaPrimer); } else { cronograma = calcularInteresCompuestoDiario(monto, tasa, plazo, fechaPrimer); } if (currentPrestamoEditId) { const idx = prestamos.findIndex((pr) => pr.id === currentPrestamoEditId); if (idx !== -1) { prestamos[idx] = { ...prestamos[idx], nombre, tipo, monto: monto.toFixed(2), tasa: tasa.toFixed(2), plazo, fechaInicio, fechaPrimer, cronograma }; } } else { const nuevo = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), nombre, tipo, monto: monto.toFixed(2), tasa: tasa.toFixed(2), plazo, fechaInicio, fechaPrimer, cronograma, pagadas: [] }; prestamos.push(nuevo); } guardarPrestamos(); prestamoForm.reset(); currentPrestamoEditId = null; if (prestamoFormContainer) prestamoFormContainer.classList.add('hidden'); showToast('Préstamo guardado'); actualizarVistaPrestamos(); }); } let calYear, calMonth; function formatDateKey(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } function generarCalendario() { const grid = document.getElementById('calendar-grid'); if (!grid) return; grid.innerHTML = ''; const firstDay = new Date(calYear, calMonth, 1); const startWeekday = firstDay.getDay(); const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate(); const prevDays = startWeekday === 0 ? 6 : startWeekday - 1; const totalCells = prevDays + daysInMonth; const eventsByDate = {}; movimientos.forEach((m) => { const d = new Date(m.fecha); if (d.getFullYear() === calYear && d.getMonth() === calMonth) { const key = formatDateKey(d); eventsByDate[key] = eventsByDate[key] || { mov: 0, prest: 0 }; eventsByDate[key].mov += 1; } }); prestamos.forEach((p) => { p.cronograma.forEach((c) => { const d = new Date(c.fecha); if (d.getFullYear() === calYear && d.getMonth() === calMonth) { const key = formatDateKey(d); eventsByDate[key] = eventsByDate[key] || { mov: 0, prest: 0 }; eventsByDate[key].prest += 1; } }); }); for (let i = 0; i < totalCells; i++) { const cell = document.createElement('div'); cell.classList.add('calendar-cell'); let cellDate = new Date(calYear, calMonth, 1 - prevDays + i); const currentMonth = cellDate.getMonth() === calMonth; if (!currentMonth) { cell.classList.add('disabled'); } const numberEl = document.createElement('div'); numberEl.classList.add('day-number'); numberEl.textContent = cellDate.getDate(); cell.appendChild(numberEl); const key = formatDateKey(cellDate); const ev = eventsByDate[key]; if (ev) { const dots = document.createElement('div'); dots.classList.add('event-dots'); if (ev.mov) { const dot = document.createElement('span'); dot.classList.add('event-dot', 'event-movimiento'); dots.appendChild(dot); } if (ev.prest) { const dot = document.createElement('span'); dot.classList.add('event-dot', 'event-prestamo'); dots.appendChild(dot); } cell.appendChild(dots); } cell.addEventListener('click', () => { mostrarDetallesDia(cellDate); }); grid.appendChild(cell); } const titleEl = document.getElementById('calendar-title'); if (titleEl) { titleEl.textContent = `${getMonthName(calMonth)} ${calYear}`; } } function mostrarDetallesDia(date) { const detailsEl = document.getElementById('calendar-details'); if (!detailsEl) return; detailsEl.classList.remove('hidden'); detailsEl.innerHTML = ''; const dateStr = date.toLocaleDateString('es-DO'); const title = document.createElement('h3'); title.textContent = `Detalles del ${dateStr}`; detailsEl.appendChild(title); const movs = movimientos.filter((m) => { const d = new Date(m.fecha); return d.getFullYear() === date.getFullYear() && d.getMonth() === date.getMonth() && d.getDate() === date.getDate(); }); const prestamosCuotas = []; prestamos.forEach((p) => { p.cronograma.forEach((c, idx) => { const d = new Date(c.fecha); if (d.getFullYear() === date.getFullYear() && d.getMonth() === date.getMonth() && d.getDate() === date.getDate()) { prestamosCuotas.push({ prestamo: p.nombre, cuota: idx + 1, importe: c.cuota_total }); } }); }); if (movs.length === 0 && prestamosCuotas.length === 0) { const none = document.createElement('p'); none.textContent = 'No hay eventos para este día.'; detailsEl.appendChild(none); return; } if (movs.length > 0) { const movTitle = document.createElement('h4'); movTitle.textContent = 'Movimientos'; detailsEl.appendChild(movTitle); const list = document.createElement('ul'); list.classList.add('detail-list'); let movTotal = 0; movs.forEach((m) => { const item = document.createElement('li'); item.classList.add('detail-item'); const desc = `${m.tipo === 'ingreso' ? '+' : '-'} ${m.categoria}`; item.innerHTML = `<span>${desc}</span><span>${formatCurrency(parseFloat(m.monto))}</span>`; list.appendChild(item); if (m.tipo === 'ingreso') movTotal += parseFloat(m.monto); else movTotal -= parseFloat(m.monto); }); detailsEl.appendChild(list); const totalEl = document.createElement('p'); totalEl.style.fontWeight = 'bold'; totalEl.textContent = `Total movimientos: ${formatCurrency(movTotal)}`; detailsEl.appendChild(totalEl); } if (prestamosCuotas.length > 0) { const loanTitle = document.createElement('h4'); loanTitle.textContent = 'Cuotas de préstamos'; detailsEl.appendChild(loanTitle); const list2 = document.createElement('ul'); list2.classList.add('detail-list'); let cuotaTotal = 0; prestamosCuotas.forEach((c) => { const item = document.createElement('li'); item.classList.add('detail-item'); item.innerHTML = `<span>${c.prestamo} (cuota ${c.cuota})</span><span>${formatCurrency(c.importe)}</span>`; list2.appendChild(item); cuotaTotal += c.importe; }); detailsEl.appendChild(list2); const totalEl2 = document.createElement('p'); totalEl2.style.fontWeight = 'bold'; totalEl2.textContent = `Total cuotas: ${formatCurrency(cuotaTotal)}`; detailsEl.appendChild(totalEl2); } } function actualizarVistaCalendario() { const now = new Date(); if (calYear === undefined || calMonth === undefined) { calYear = now.getFullYear(); calMonth = now.getMonth(); } generarCalendario(); } const calPrevBtn = document.getElementById('cal-prev'); const calNextBtn = document.getElementById('cal-next'); if (calPrevBtn) { calPrevBtn.addEventListener('click', () => { if (calMonth === 0) { calMonth = 11; calYear -= 1; } else { calMonth -= 1; } generarCalendario(); }); } if (calNextBtn) { calNextBtn.addEventListener('click', () => { if (calMonth === 11) { calMonth = 0; calYear += 1; } else { calMonth += 1; } generarCalendario(); }); } function guardarPresupuestos() { localStorage.setItem('presupuestos', JSON.stringify(presupuestos)); } function actualizarVistaPresupuesto() { actualizarResumenPresupuesto(); const listEl = document.getElementById('presupuesto-list'); if (!listEl) return; listEl.innerHTML = ''; if (presupuestos.length === 0) { const empty = document.createElement('p'); empty.textContent = 'No hay categorías de presupuesto.'; empty.style.textAlign = 'center'; listEl.appendChild(empty); return; } const now = new Date(); const curMonth = now.getMonth(); const curYear = now.getFullYear(); const gastosPorCat = {}; movimientos.forEach((m) => { const d = new Date(m.fecha); if (m.tipo === 'gasto' && d.getMonth() === curMonth && d.getFullYear() === curYear) { gastosPorCat[m.categoria] = (gastosPorCat[m.categoria] || 0) + parseFloat(m.monto); } }); presupuestos.forEach((cat) => { const card = document.createElement('div'); card.classList.add('budget-card'); const header = document.createElement('div'); header.classList.add('budget-header'); const nameEl = document.createElement('div'); nameEl.classList.add('budget-name'); nameEl.textContent = cat.nombre; const typeEl = document.createElement('div'); typeEl.classList.add('budget-type'); typeEl.textContent = cat.tipo.charAt(0).toUpperCase() + cat.tipo.slice(1); header.appendChild(nameEl); header.appendChild(typeEl); card.appendChild(header); const progress = document.createElement('div'); progress.classList.add('budget-progress'); const progressBar = document.createElement('span'); const gastado = gastosPorCat[cat.nombre] || 0; const porcentaje = cat.limite > 0 ? (gastado / cat.limite) : 0; progressBar.style.width = `${Math.min(100, porcentaje * 100)}%`; if (porcentaje < 0.5) progress.classList.add('green'); else if (porcentaje <= 1) progress.classList.add('yellow'); else progress.classList.add('red'); progress.appendChild(progressBar); card.appendChild(progress); const metrics = document.createElement('div'); metrics.classList.add('budget-metrics'); const gastadoEl = document.createElement('span'); gastadoEl.textContent = `${formatCurrency(gastado)}/${formatCurrency(parseFloat(cat.limite))}`; const restanteEl = document.createElement('span'); const restante = cat.limite - gastado; restanteEl.textContent = restante >= 0 ? `Restante: ${formatCurrency(restante)}` : `Exceso: ${formatCurrency(Math.abs(restante))}`; metrics.appendChild(gastadoEl); metrics.appendChild(restanteEl); card.appendChild(metrics); listEl.appendChild(card); }); } function actualizarResumenPresupuesto() { const summaryEl = document.getElementById('presupuesto-summary'); if (!summaryEl) return; summaryEl.innerHTML = ''; let totalIngresos = 0; let totalGastos = 0; const now = new Date(); const curMonth = now.getMonth(); const curYear = now.getFullYear(); movimientos.forEach((m) => { const d = new Date(m.fecha); if (d.getMonth() === curMonth && d.getFullYear() === curYear) { if (m.tipo === 'ingreso') totalIngresos += parseFloat(m.monto); else totalGastos += parseFloat(m.monto); } }); const balance = totalIngresos - totalGastos; if (totalIngresos === 0) { const info = document.createElement('p'); info.textContent = 'Sin ingresos registrados este mes para calcular la distribución 50/30/20.'; info.style.textAlign = 'center'; summaryEl.appendChild(info); return; } const needs = totalIngresos * 0.5; const wants = totalIngresos * 0.3; const savings = totalIngresos * 0.2; const container = document.createElement('div'); container.classList.add('distribution-card', 'card'); const title = document.createElement('h3'); title.textContent = 'Distribución 50/30/20'; container.appendChild(title); const bars = document.createElement('div'); bars.classList.add('distribution-bars'); const barN = document.createElement('div'); barN.classList.add('distribution-bar', 'need'); barN.style.width = '50%'; barN.innerHTML = `<span>${formatCurrency(needs)}</span>`; const barW = document.createElement('div'); barW.classList.add('distribution-bar', 'want'); barW.style.width = '30%'; barW.innerHTML = `<span>${formatCurrency(wants)}</span>`; const barS = document.createElement('div'); barS.classList.add('distribution-bar', 'saving'); barS.style.width = '20%'; barS.innerHTML = `<span>${formatCurrency(savings)}</span>`; bars.appendChild(barN); bars.appendChild(barW); bars.appendChild(barS); container.appendChild(bars); summaryEl.appendChild(container); } const btnNuevoPresupuesto = document.getElementById('btn-nuevo-presupuesto'); const presupuestoFormContainer = document.getElementById('presupuesto-form-container'); const presupuestoForm = document.getElementById('presupuesto-form'); if (btnNuevoPresupuesto) { btnNuevoPresupuesto.addEventListener('click', () => { if (presupuestoFormContainer) { presupuestoFormContainer.classList.toggle('hidden'); if (!presupuestoFormContainer.classList.contains('hidden') && presupuestoForm) { presupuestoForm.reset(); } } }); } if (presupuestoForm) { presupuestoForm.addEventListener('submit', (e) => { e.preventDefault(); const nombre = document.getElementById('budget-nombre').value.trim(); const tipo = document.getElementById('budget-tipo').value; const limiteVal = document.getElementById('budget-limite').value; if (!nombre || !limiteVal) { showToast('Completa todos los campos'); return; } const limite = parseFloat(limiteVal); presupuestos.push({ id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), nombre, tipo, limite }); guardarPresupuestos(); presupuestoForm.reset(); if (presupuestoFormContainer) presupuestoFormContainer.classList.add('hidden'); showToast('Categoría guardada'); actualizarVistaPresupuesto(); }); } function exportDataset(data, format, filename) { let content = ''; let mime = 'text/plain'; if (format === 'json') { mime = 'application/json'; content = JSON.stringify(data, null, 2); } else if (format === 'csv') { if (Array.isArray(data) && data.length > 0) { const keys = Object.keys(data[0]); const rows = [keys.join(',')]; data.forEach((item) => { const row = keys.map((k) => { const val = item[k]; return typeof val === 'string' ? '"' + val.replace(/"/g, '""') + '"' : val; }); rows.push(row.join(',')); }); content = rows.join('\n'); mime = 'text/csv'; } } else if (format === 'txt') { content = Array.isArray(data) ? data.map((i) => JSON.stringify(i)).join('\n') : JSON.stringify(data); mime = 'text/plain'; } const blob = new Blob([content], { type: mime }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 0); } const btnExportar = document.getElementById('btn-exportar'); if (btnExportar) { btnExportar.addEventListener('click', () => { const fmt = document.getElementById('export-format').value; const toExport = []; if (document.getElementById('export-movimientos').checked) { toExport.push({ name: 'movimientos', data: movimientos }); } if (document.getElementById('export-cuentas').checked) { toExport.push({ name: 'cuentas', data: cuentas }); } if (document.getElementById('export-prestamos').checked) { const prestamosData = []; prestamos.forEach((p) => { p.cronograma.forEach((c) => { prestamosData.push({ prestamo: p.nombre, cuota: c.cuota, fecha: c.fecha, interes: c.interes, capital: c.capital, cuota_total: c.cuota_total, saldo_restante: c.saldo_restante }); }); }); toExport.push({ name: 'prestamos', data: prestamosData }); } if (document.getElementById('export-presupuestos').checked) { toExport.push({ name: 'presupuestos', data: presupuestos }); } if (toExport.length === 0) { showToast('Selecciona al menos un tipo de datos'); return; } toExport.forEach((item) => { const filename = `${item.name}.${fmt}`; exportDataset(item.data, fmt, filename); }); showToast('Exportación completada'); }); } const btnExportarPdf = document.getElementById('btn-exportar-pdf'); if (btnExportarPdf) { btnExportarPdf.addEventListener('click', () => { showToast('Generando PDF...'); try { let JSCls = null; if (window.jspdf && window.jspdf.jsPDF) { JSCls = window.jspdf.jsPDF; } else if (window.jsPDF) { JSCls = window.jsPDF; } else if (typeof jsPDF !== 'undefined') { JSCls = jsPDF; } if (!JSCls) { throw new Error('jsPDF no disponible'); } const doc = new JSCls({ orientation: 'p', unit: 'pt', format: 'a4' }); let y = 40; doc.setFontSize(18); doc.text('Informe financiero del mes', 40, y); y += 30; doc.setFontSize(12); let totalIngresos = 0; let totalGastos = 0; const now = new Date(); const curMonth = now.getMonth(); const curYear = now.getFullYear(); movimientos.forEach((m) => { const d = new Date(m.fecha); if (d.getMonth() === curMonth && d.getFullYear() === curYear) { if (m.tipo === 'ingreso') totalIngresos += parseFloat(m.monto); else totalGastos += parseFloat(m.monto); } }); const balance = totalIngresos - totalGastos; doc.text(`Ingresos: ${formatCurrency(totalIngresos)}`, 40, y); y += 20; doc.text(`Gastos: ${formatCurrency(totalGastos)}`, 40, y); y += 20; doc.text(`Balance: ${formatCurrency(balance)}`, 40, y); y += 30; doc.setFontSize(14); doc.text('Resumen de presupuesto', 40, y); y += 20; doc.setFontSize(12); if (presupuestos.length === 0) { doc.text('No hay categorías de presupuesto definidas.', 40, y); y += 20; } else { presupuestos.forEach((cat) => { doc.text(`${cat.nombre}: límite ${formatCurrency(cat.limite)}`, 40, y); y += 15; }); y += 10; } doc.setFontSize(14); doc.text('Resumen de préstamos', 40, y); y += 20; doc.setFontSize(12); if (prestamos.length === 0) { doc.text('No hay préstamos registrados.', 40, y); y += 20; } else { prestamos.forEach((p) => { const cuota0 = p.cronograma && p.cronograma[0] ? p.cronograma[0].cuota_total : 0; doc.text(`${p.nombre}: cuota mensual aprox. ${formatCurrency(cuota0)}`, 40, y); y += 15; }); y += 10; } doc.save('informe_financiero.pdf'); showToast('PDF generado'); } catch (err) { console.error(err); showToast('Error al generar PDF'); } }); } function cargarAjustes() { const nameEl = document.getElementById('user-name'); const currencyEl = document.getElementById('user-currency'); const darkEl = document.getElementById('dark-mode-toggle'); const animEl = document.getElementById('animations-toggle'); const fontEl = document.getElementById('font-size-select'); const contrastEl = document.getElementById('contrast-toggle'); if (nameEl) nameEl.value = ajustes.userName || ''; if (currencyEl) currencyEl.value = ajustes.currency || 'USD'; if (darkEl) darkEl.checked = ajustes.darkMode || false; if (animEl) animEl.checked = ajustes.animations || false; if (fontEl) fontEl.value = ajustes.fontSize || 'med'; if (contrastEl) contrastEl.checked = ajustes.contrast || false; if (ajustes.darkMode) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); document.documentElement.classList.remove('font-small', 'font-med', 'font-large'); if (ajustes.fontSize === 'small') document.documentElement.classList.add('font-small'); else if (ajustes.fontSize === 'large') document.documentElement.classList.add('font-large'); else document.documentElement.classList.add('font-med'); if (ajustes.contrast) document.documentElement.classList.add('contrast-high'); else document.documentElement.classList.remove('contrast-high'); } function guardarAjustes() { const nameEl = document.getElementById('user-name'); const currencyEl = document.getElementById('user-currency'); const darkEl = document.getElementById('dark-mode-toggle'); const animEl = document.getElementById('animations-toggle'); ajustes.userName = nameEl ? nameEl.value.trim() : ''; ajustes.currency = currencyEl ? currencyEl.value : 'USD'; ajustes.darkMode = darkEl ? darkEl.checked : false; ajustes.animations = animEl ? animEl.checked : true; const fontEl = document.getElementById('font-size-select'); const contrastEl = document.getElementById('contrast-toggle'); ajustes.fontSize = fontEl ? fontEl.value : 'med'; ajustes.contrast = contrastEl ? contrastEl.checked : false; localStorage.setItem('ajustes', JSON.stringify(ajustes)); if (ajustes.darkMode) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); document.documentElement.classList.remove('font-small', 'font-med', 'font-large'); if (ajustes.fontSize === 'small') document.documentElement.classList.add('font-small'); else if (ajustes.fontSize === 'large') document.documentElement.classList.add('font-large'); else document.documentElement.classList.add('font-med'); if (ajustes.contrast) document.documentElement.classList.add('contrast-high'); else document.documentElement.classList.remove('contrast-high'); showToast('Ajustes guardados'); } const btnGuardarAjustes = document.getElementById('btn-guardar-ajustes'); if (btnGuardarAjustes) { btnGuardarAjustes.addEventListener('click', guardarAjustes); } const btnResetData = document.getElementById('btn-reset-data'); if (btnResetData) { btnResetData.addEventListener('click', () => { if (confirm('¿Seguro que deseas borrar todos los datos?')) { localStorage.clear(); location.reload(); } }); } const btnExportBackup = document.getElementById('btn-export-backup'); if (btnExportBackup) { btnExportBackup.addEventListener('click', () => { const backup = { movimientos, cuentas, prestamos, presupuestos, ajustes }; exportDataset(backup, 'json', 'backup_finanzas.json'); showToast('Backup exportado'); }); } const btnImportBackup = document.getElementById('btn-import-backup'); const importBackupInput = document.getElementById('import-backup-input'); if (btnImportBackup && importBackupInput) { btnImportBackup.addEventListener('click', () => { importBackupInput.click(); }); importBackupInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if (data.movimientos) { movimientos = data.movimientos; saveMovimientos(); } if (data.cuentas) { cuentas = data.cuentas; guardarCuentas(); } if (data.prestamos) { prestamos = data.prestamos; guardarPrestamos(); } if (data.presupuestos) { presupuestos = data.presupuestos; guardarPresupuestos(); } if (data.ajustes) { ajustes = { ...ajustes, ...data.ajustes }; localStorage.setItem('ajustes', JSON.stringify(ajustes)); } showToast('Backup importado'); updateDashboard(); actualizarVistaMovimientos(); actualizarVistaCuentas(); actualizarVistaPrestamos(); actualizarVistaPresupuesto(); actualizarVistaCalendario(); cargarAjustes(); } catch (err) { console.error(err); showToast('Archivo de backup inválido'); } }; reader.readAsText(file); importBackupInput.value = ''; }); } const btnOptimize = document.getElementById('btn-optimize-app'); if (btnOptimize) { btnOptimize.addEventListener('click', () => { if ('caches' in window) { caches.keys().then((keys) => { keys.forEach((key) => { if (key.includes('dynamic')) { caches.delete(key); } }); }); } showToast('Optimización completada'); }); } const movimientoForm = document.getElementById('movimiento-form'); if (movimientoForm) { movimientoForm.addEventListener('submit', (e) => { e.preventDefault(); const tipo = document.getElementById('mov-tipo').value; const montoVal = document.getElementById('mov-monto').value; const categoria = document.getElementById('mov-categoria').value; const fecha = document.getElementById('mov-fecha').value; const nota = document.getElementById('mov-nota').value; if (!montoVal || isNaN(montoVal) || parseFloat(montoVal) <= 0) { showToast('Introduce un monto válido.'); return; } if (!categoria) { showToast('Selecciona una categoría.'); return; } if (!fecha) { showToast('Selecciona una fecha.'); return; } const movimiento = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), tipo, monto: parseFloat(montoVal).toFixed(2), categoria, fecha, nota: nota.trim() }; movimientos.push(movimiento); saveMovimientos(); movimientoForm.reset(); document.querySelectorAll('.category-chip.selected').forEach((chip) => { chip.classList.remove('selected'); }); updateDashboard(); actualizarVistaMovimientos(); showToast('Movimiento guardado'); showView('movimientos'); }); } const categoryChips = document.querySelectorAll('.category-chip'); categoryChips.forEach((chip) => { chip.addEventListener('click', () => { const value = chip.getAttribute('data-value'); const select = document.getElementById('mov-categoria'); if (select) { select.value = value; } categoryChips.forEach((c) => c.classList.remove('selected')); chip.classList.add('selected'); }); }); updateDashboard(); cargarAjustes(); });